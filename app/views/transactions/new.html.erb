<%= render layout: 'shared/app_layout' do %>
  <div class="max-w-2xl mx-auto space-y-6">
    <div class="flex items-center gap-4">
      <%= link_to dashboard_path, class: "text-gray-600 hover:text-gray-900" do %>
        <%= icon :chevron_left, class: "w-5 h-5" %>
      <% end %>
      <h2 class="text-2xl font-bold text-gray-900">
        <%= @transaction_type == 'deposit' ? 'Nieuwe Storting' : 'Nieuwe Uitgave' %>
      </h2>
    </div>

    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
      <%= form_with model: @transaction, url: transactions_path, method: :post, local: true, html: { id: 'transaction-form' } do |f| %>
        <% if @transaction.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <%= icon :x_circle, class: "w-5 h-5 text-red-600 mt-0.5" %>
              <div class="flex-1">
                <h4 class="font-medium text-red-900">
                  <%= pluralize(@transaction.errors.count, "fout") %> gevonden:
                </h4>
                <ul class="mt-2 text-sm text-red-700 list-disc list-inside space-y-1">
                  <% @transaction.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        <% end %>

        <%= f.hidden_field :transaction_type, value: @transaction_type %>

        <div class="space-y-6">
          <!-- Amount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Bedrag *
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">â‚¬</span>
              <input
                type="number"
                name="amount_euros"
                id="amount_euros"
                step="0.01"
                min="0.01"
                required
                placeholder="0.00"
                class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
            </div>
            <p class="text-xs text-gray-500 mt-1">Voer het bedrag in euro's in</p>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Beschrijving *
            </label>
            <%= f.text_field :description,
              class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
              placeholder: @transaction_type == 'deposit' ? 'Bijv. Maandelijkse bijdrage' : 'Bijv. Boodschappen',
              required: true
            %>
          </div>

          <!-- Token Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Token
            </label>
            <%= f.select :token,
              [['EURe (aanbevolen)', 'EURe'], ['DUMMY (test)', 'DUMMY'], ['ETH', 'ETH']],
              { selected: 'EURe' },
              class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            %>
          </div>

          <% if @transaction_type == 'expense' %>
            <!-- Split Info -->
            <div class="p-4 bg-blue-50 rounded-lg">
              <div class="flex items-start gap-3">
                <%= icon :info, class: "w-5 h-5 text-blue-600 mt-0.5" %>
                <div class="flex-1">
                  <p class="font-medium text-blue-900">Splitsmethode</p>
                  <p class="text-sm text-blue-700 mt-1">
                    Deze uitgave wordt gesplitst volgens de '<%= @account.split_method %>' methode
                    <% if @account.equal? %>
                      - gelijk verdeeld over <%= @account.active_members_count %> <%= @account.active_members_count == 1 ? 'lid' : 'leden' %>
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          <% end %>

          <!-- Actions -->
          <div class="flex gap-3 pt-4">
            <%= f.submit @transaction_type == 'deposit' ? 'Storting Toevoegen' : 'Uitgave Toevoegen',
              class: "flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium transition-colors cursor-pointer"
            %>
            <%= link_to 'Annuleren', dashboard_path,
              class: "px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
            %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <script>
    // Convert euros to cents before form submission
    document.getElementById('transaction-form').addEventListener('submit', function(e) {
      const amountInput = document.getElementById('amount_euros');
      const euros = parseFloat(amountInput.value);

      if (isNaN(euros) || euros <= 0) {
        e.preventDefault();
        alert('Voer een geldig bedrag in');
        return;
      }

      // Create hidden field for amount_euros in transaction params
      const centsInput = document.createElement('input');
      centsInput.type = 'hidden';
      centsInput.name = 'transaction[amount_euros]';
      centsInput.value = euros;
      this.appendChild(centsInput);

      // Remove original input name so it doesn't get submitted
      amountInput.removeAttribute('name');
    });
  </script>
<% end %>
